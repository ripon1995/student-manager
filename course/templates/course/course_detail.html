{% extends 'course/base_course.html' %}

{% block content %}
    <style>
        .card {
            width: 100% !important;
            height: 300px !important;
            background: #fff;
            border: 2px solid #ccc;
            border-radius: 10px;
            padding: 30px;
            text-align: left;
        }

        .card:hover {
            background: #fff;
        }
    </style>

    <div class="card shadow mb-4" style="width: 100%; height: 300px; background-color: whitesmoke">
        <div class="card-body d-flex flex-column justify-content-between h-100">
            <div>
                <h4 style="text-align: center" class="card-title">{{ course.title }}</h4>
                <p style="text-align: center; text-decoration: underline" class="card-text">
                    {{ course.description|default:"No description provided." }}
                </p>
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="card-subtitle mb-2 text-muted">
                        Start From: {{ course.created_at|date:"F j, Y" }}
                    </h6>
                    <h6 class="card-subtitle mb-2 text-muted">
                        Course fee: {{ course.course_fee }}
                    </h6>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="card-subtitle mb-2 text-muted">
                        Capacity: {{ course.capacity }}
                    </h6>
                    <h6 class="card-subtitle mb-2 text-muted">
                        Current student: {{ course.students.count }}
                    </h6>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="card-subtitle mb-2 text-muted">
                        Days: {{ course.days }}
                    </h6>
                    <h6 class="card-subtitle mb-2 text-muted">
                        Time: {{ course.time }}
                    </h6>
                </div>

                <i><p style="text-align: center"> {{ course.course_quote }} </p></i>
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="card-subtitle mb-2 text-muted">
                        <a href="#" id="show-attendance-form"> <i class="fa-solid fa-clipboard-user"></i> Attendance</a>
                    </h6>
                    <h6 class="card-subtitle mb-2 text-muted">
                        <a href="#" id="show-student-list"> <i class="fa-solid fa-list-ol"></i> Student List </a>
                    </h6>
                    <h6 class="card-subtitle mb-2 text-muted">
                        <a href="#" id="show-custom-attendance-list"> <i class="fa-solid fa-calendar"></i> View
                            Attendance</a>
                    </h6>
                </div>
            </div>

        </div>
    </div>

    <div id="student-list" class="mt-3" style="display: none;">
        <div class="card" style="border-radius: 0px; background-color: #f3f3f3;">
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <h5 class="card-title"><i class="fa-solid fa-list"></i> Student List</h5>
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between align-items-center"
                        style="background-color: #204d74; color: white; font-weight: bold;">
                        <span>SL</span>
                        <span>Name</span>
                        <span>Start From</span>
                    </li>
                    {% for student in course.students.all %}
                        <li class="list-group-item d-flex justify-content-between align-items-center"
                            style="background-color: #5b8ec6;">
                            <span style="color:white">{{ forloop.counter }}</span>
                            <span style="color: white">{{ student.first_name }} {{ student.last_name }}</span>
                            <span style="color: white">{{ student.start_date }}</span>
                        </li>
                    {% empty %}
                        <li class="list-group-item">No students enrolled.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div id="attendance-form" class="mt-3" style="display: none;">
        <form method="POST">
            {% csrf_token %}
            <div class="card" style="border-radius: 0px; background-color: #f3f3f3;">
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <h5 class="card-title"><i class="fa-solid fa-clipboard-user"></i> Take Attendance</h5>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center"
                            style="background-color: #204d74; color: white; font-weight: bold;">
                            <span>SL</span>
                            <span>Name</span>
                            <span>Present</span>
                        </li>
                        {% for student in course.students.all %}
                            <li class="list-group-item d-flex justify-content-between align-items-center"
                                style="background-color: #5b8ec6;">
                                <span style="color:white">{{ forloop.counter }}</span>
                                <span style="color:white">{{ student.first_name }} {{ student.last_name }}</span>
                                <input type="checkbox" name="student_{{ student.id }}"
                                       data-student-id="{{ student.id }}" value="1">
                            </li>
                        {% empty %}
                            <li class="list-group-item">No students enrolled.</li>
                        {% endfor %}
                    </ul>
                    <br>
                    <button type="submit" class="btn btn-success">Submit Attendance</button>
                </div>
            </div>
        </form>
    </div>

    <div id="attendance-date-picker" class="mt-3" style="display: none;">
        <div class="card" style="border-radius: 0px; background-color: #f3f3f3;">
            <div class="card-body">
                <label for="attendance-date">Select Date:</label>
                <input type="date" id="attendance-date" class="form-control"/>
                <button id="view-attendance-btn" class="btn btn-primary mt-2">View Attendance</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const courseId = '{{ course.id }}';

            // Student list toggle
            const link = document.getElementById('show-student-list');
            const listDiv = document.getElementById('student-list');
            if (link) {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    listDiv.style.display = listDiv.style.display === 'none' ? 'block' : 'none';
                });
            }

            // Attendance form toggle and fetch
            const attendanceLink = document.getElementById('show-attendance-form');
            const attendanceFormDiv = document.getElementById('attendance-form');
            if (attendanceLink) {
                attendanceLink.addEventListener('click', function (e) {
                    e.preventDefault();
                    attendanceFormDiv.style.display = attendanceFormDiv.style.display === 'none' ? 'block' : 'none';

                    // Get today's date
                    const date = new Date().toISOString().slice(0, 10);
                    const url = 'http://127.0.0.1:8000/attendance/api/attendances/list/';
                    // Call the attendance list API
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            course: courseId,
                            date: date
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            const presentStudentIds = data.map(item => item.student);
                            const checkboxes = attendanceFormDiv.querySelectorAll('input[type="checkbox"][data-student-id]');
                            checkboxes.forEach(cb => {
                                cb.checked = !!presentStudentIds.includes(cb.getAttribute('data-student-id'));
                            });
                        })
                        .catch(error => {
                            alert('Error fetching attendance data.');
                        });
                });
            }

            // Attendance form submit
            const attendanceForm = attendanceFormDiv.querySelector('form');
            if (attendanceForm) {
                attendanceForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const checkboxes = attendanceForm.querySelectorAll('input[type="checkbox"]:checked');
                    const students = Array.from(checkboxes).map(cb => cb.getAttribute('data-student-id'));

                    // Get course ID and date (set date as today)
                    const date = new Date().toISOString().slice(0, 10);
                    const url = 'http://127.0.0.1:8000/attendance/api/attendances/';
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            course: courseId,
                            date: date,
                            students: students
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            alert('Attendance submitted!');
                        })
                        .catch(error => {
                            alert('Error submitting attendance.');
                        });
                });
            }


            const viewAttendanceLink = document.getElementById('show-custom-attendance-list');
            const datePickerDiv = document.getElementById('attendance-date-picker');
            const viewAttendanceBtn = document.getElementById('view-attendance-btn');
            const attendanceDateInput = document.getElementById('attendance-date');

            if (viewAttendanceLink) {
                viewAttendanceLink.addEventListener('click', function (e) {
                    e.preventDefault();
                    datePickerDiv.style.display = datePickerDiv.style.display === 'none' ? 'block' : 'none';
                });
            }

            if (viewAttendanceBtn) {
                viewAttendanceBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    const selectedDate = attendanceDateInput.value;
                    if (!selectedDate) {
                        alert('Please select a date.');
                        return;
                    }
                    // Call your attendance list API with selectedDate
                    fetch('http://127.0.0.1:8000/attendance/api/attendances/list/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            course: courseId,
                            date: selectedDate
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            // Handle/display attendance data for selected date
                            alert('Attendance data loaded for ' + selectedDate);
                            // You can render the data as needed here
                        })
                        .catch(error => {
                            alert('Error fetching attendance data.');
                        });
                });
            }

        });
    </script>
{% endblock %}